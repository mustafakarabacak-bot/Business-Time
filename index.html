<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Time</title>
  <!-- PWA manifest ve ikon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png">
  <!-- Chart.js (HTTPS ile y√ºkleniyor) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f4f6fc;
      --text: #1a1a1a;
      --box: #ffffff;
      --accent: #1a73e8;
      --gold: #d4af37;
      --work-color: rgba(26, 115, 232, 0.8);
      --idle-color: rgba(232, 26, 26, 0.8);
      --earn-color: rgba(26, 232, 26, 0.8);
    }
    body.dark {
      --bg: #121212;
      --text: #f4f4f4;
      --box: #1e1e1e;
      --accent: #8ab4f8;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1vw 5vw;
      background: var(--box);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .logo {
      height: 40px;
    }
    .profile-info {
      display: flex;
      align-items: center;
      gap: 1vw;
    }
    .profile-photo {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      object-fit: cover;
      display: none;
    }
    .username {
      font-size: 4vw;
      opacity: 0.7;
      display: none;
    }
    .container {
      flex: 1;
      padding: 2vw 5vw;
      overflow-y: auto;
    }
    .input-group {
      max-width: 500px;
      margin: 2vw auto;
    }
    .input-group label {
      display: block;
      margin-bottom: 1vw;
      font-weight: 600;
      font-size: 4vw;
    }
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 2vw;
      border-radius: 1vw;
      font-size: 4vw;
      border: 1px solid #ccc;
      background: var(--box);
      color: var(--text);
    }
    .time-group {
      display: flex;
      gap: 2vw;
    }
    .buttons {
      max-width: 500px;
      margin: 2vw auto;
      display: flex;
      flex-wrap: wrap;
      gap: 2vw;
      justify-content: center;
    }
    .buttons button {
      flex: 1 1 30%;
      padding: 3vw;
      font-size: 5vw;
      font-weight: bold;
      border: none;
      border-radius: 1vw;
      cursor: pointer;
      min-width: 100px;
    }
    .start-btn { background: #34a853; color: white; }
    .stop-btn  { background: #ea4335; color: white; }
    .break-btn { background: #ff9800; color: white; }
    .reset-btn { background: #fbbc04; color: white; }
    .dark-toggle { background: var(--accent); color: white; }
    .earnings-box {
      max-width: 500px;
      margin: 3vw auto;
      background: var(--box);
      font-size: 7vw;
      font-weight: bold;
      padding: 4vw;
      text-align: center;
      border-radius: 2vw;
      color: var(--gold);
    }
    .earnings-detail {
      max-width: 500px;
      margin: 1vw auto;
      font-size: 4vw;
      text-align: center;
      color: var(--text);
    }
    .summary {
      max-width: 500px;
      margin: 2vw auto 6vw;
      font-size: 5vw;
      text-align: center;
      color: var(--text);
    }
    .remaining {
      max-width: 500px;
      margin: 1vw auto;
      font-size: 4vw;
      text-align: center;
      color: var(--accent);
    }
    .chart-container {
      max-width: 500px;
      margin: 2vw auto;
    }
    #earningsChart,
    #workChart,
    #idleChart {
      width: 100% !important;
      height: auto !important;
    }
    .nav {
      display: flex;
      justify-content: space-around;
      background: var(--box);
      padding: 1vw 0;
      border-top: 1px solid #ccc;
    }
    .nav button {
      background: none;
      border: none;
      font-size: 5vw;
      font-weight: bold;
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .nav-icon {
      font-size: 8vw;
    }
    .hidden { display: none; }
    /* Grafik ba≈ülƒ±klarƒ± */
    .chart-title {
      text-align: center;
      font-size: 5vw;
      font-weight: 600;
      margin-bottom: 1vw;
      color: var(--text);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="icon.png" class="logo" alt="logo" />
    <div class="profile-info">
      <img id="profilePhoto" class="profile-photo" src="" alt="Profil Fotoƒürafƒ±" />
    </div>
  </header>

  <!-- Container -->
  <div class="container">
    <!-- Ana Sayfa -->
    <main id="mainView">
      <div class="input-group">
        <label for="salary">Maa≈ü Bilgisi (TL)</label>
        <input type="number" id="salary" placeholder="Aylƒ±k maa≈üƒ±nƒ±zƒ± girin" min="1" step="100">
      </div>
      <div class="input-group">
        <label for="monthlyLimit">Aylƒ±k √áalƒ±≈üma S√ºresi Limiti (saat)</label>
        <input type="number" id="monthlyLimit" placeholder="√ñrn: 160" min="1" step="1">
      </div>
      <div class="input-group">
        <label>Ek S√ºre</label>
        <div class="time-group">
          <input type="number" id="extraHours" placeholder="Saat" min="0" step="1">
          <input type="number" id="extraMinutes" placeholder="Dakika" min="0" step="1">
        </div>
      </div>
      <div class="input-group">
        <label>G√ºnl√ºk Hedef (saat)</label>
        <input type="number" id="dailyGoal" placeholder="√ñrn: 8" min="1" step="1">
      </div>
      <div class="buttons">
        <button class="start-btn"   onclick="startTracking()">BA≈ûLAT</button>
        <button class="stop-btn"    onclick="stopTracking()">DURDUR</button>
        <button class="break-btn"   onclick="toggleBreak()" id="breakButton">MOLA</button>
        <button class="reset-btn"   onclick="confirmDailyReset()">SIFIRLA (G√ºnl√ºk)</button>
        <button class="dark-toggle" onclick="toggleDarkMode()">GECE MODU</button>
      </div>
      <div class="earnings-box" id="earnings">0,00 TL</div>
      <div class="earnings-detail" id="earningsDetail"></div>
      <div class="remaining" id="remainingTime"></div>
      <div class="summary">
        <div id="timeDisplay">Toplam S√ºre: 0 saat 0 dakika 0 saniye</div>
        <div id="overtimeDisplay">Fazla Mesai: 0 saat 0 dakika 0 saniye</div>
      </div>
    </main>

    <!-- Profil -->
    <main id="profileView" class="hidden">
      <h2 class="chart-title">√áalƒ±≈üƒ±lan Zaman (Saat)</h2>
      <canvas id="workChart"></canvas>
      <h2 class="chart-title">Bo≈üta Kalan S√ºre (Saat)</h2>
      <canvas id="idleChart"></canvas>
      <h2 class="chart-title">Kazanƒ±lan Para (TL)</h2>
      <canvas id="earningsChart"></canvas>
    </main>

    <!-- Ayarlar -->
    <main id="settingsView" class="hidden">
      <h2>Ayarlar</h2>
      <label for="currency">D√∂viz Cinsi</label>
      <select id="currency">
        <option value="TL">TL</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
      </select>
      <label for="exchangeRate">D√∂viz Kuru (1 birim USD/EUR = ? TL)</label>
      <input type="number" step="0.01" id="exchangeRate" placeholder="√ñrn: 32.50">
      <label for="overtimeMultiplier">Fazla Mesai √áarpanƒ±</label>
      <input type="number" step="0.1" id="overtimeMultiplier" placeholder="√ñrn: 1.5 (default)">
      <label for="themeSelect">Tema</label>
      <select id="themeSelect">
        <option value="auto">Otomatik</option>
        <option value="light">Aydƒ±nlƒ±k</option>
        <option value="dark">Koyu</option>
      </select>
      <button onclick="confirmAllReset()">T√ºm Verileri Sƒ±fƒ±rla</button>
    </main>
  </div>

  <!-- Alt Men√º -->
  <nav class="nav">
    <button onclick="showView('main')">
      <span class="nav-icon">üè†</span>
      Ana Sayfa
    </button>
    <button onclick="showView('profile')">
      <span class="nav-icon">üë§</span>
      Profil
    </button>
    <button onclick="showView('settings')">
      <span class="nav-icon">‚öôÔ∏è</span>
      Ayarlar
    </button>
  </nav>

  <!-- Ses Efektleri (Ses yoksa gizli ge√ßi≈ü) -->
  <audio id="startSound" style="display:none"></audio>
  <audio id="stopSound" style="display:none"></audio>

  <script>
    // Deƒüi≈ükenler
    let timer;
    let startTimestamp = parseInt(localStorage.getItem('startTimestamp')) || null;
    let baseSeconds = parseInt(localStorage.getItem('baseSeconds')) || 0;
    let isRunning = localStorage.getItem('isRunning') === 'true';
    let goal = parseFloat(localStorage.getItem('dailyGoal')) || 8;
    let currency = localStorage.getItem('currency') || 'TL';
    let exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 1;
    let overtimeMultiplier = parseFloat(localStorage.getItem('overtimeMultiplier')) || 1.5;
    let earnings = parseFloat(localStorage.getItem('earnings')) || 0;
    let name = localStorage.getItem('username');
    let monthlyLimit = parseFloat(localStorage.getItem('monthlyLimit')) || 180;

    // Mola deƒüi≈ükenleri
    let isOnBreak = localStorage.getItem('isOnBreak') === 'true';
    let breakStartTimestamp = parseInt(localStorage.getItem('breakStartTimestamp')) || null;
    let accumulatedBreakSeconds = parseInt(localStorage.getItem('accumulatedBreakSeconds')) || 0;

    // Ayarlama: Otomatik aylƒ±k sƒ±fƒ±rlama
    const nowDate = new Date();
    const currentMonthKey = nowDate.getMonth() + '-' + nowDate.getFullYear();
    const storedMonthKey = localStorage.getItem('lastRecordedMonth');
    if (storedMonthKey !== currentMonthKey) {
      baseSeconds = 0;
      accumulatedBreakSeconds = 0;
      localStorage.setItem('baseSeconds', '0');
      localStorage.setItem('accumulatedBreakSeconds', '0');
      localStorage.setItem('lastRecordedMonth', currentMonthKey);
    }

    // Profil Fotoƒürafƒ±
    const photoUpload = document.getElementById('photoUpload');
    const profilePhoto = document.getElementById('profilePhoto');
    if (localStorage.getItem('profilePhoto')) {
      profilePhoto.src = localStorage.getItem('profilePhoto');
      profilePhoto.style.display = 'block';
    }
    photoUpload && (photoUpload.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        localStorage.setItem('profilePhoto', evt.target.result);
        profilePhoto.src = evt.target.result;
        profilePhoto.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // ƒ∞sim ƒ∞steme
    if (!name) {
      name = prompt("Ho≈ü geldiniz! L√ºtfen adƒ±nƒ±zƒ± ve soyadƒ±nƒ±zƒ± girin:");
      if (name) localStorage.setItem('username', name);
    }
    document.getElementById('displayName') && (document.getElementById('displayName').innerText = name || '');
    document.getElementById('displayName') && (document.getElementById('displayName').style.display = 'block');

    // Eleman referanslarƒ±
    const salaryInput       = document.getElementById('salary');
    const monthlyLimitInput = document.getElementById('monthlyLimit');
    const extraHoursInput   = document.getElementById('extraHours');
    const extraMinutesInput = document.getElementById('extraMinutes');
    const dailyGoalInput    = document.getElementById('dailyGoal');
    const currencySelect    = document.getElementById('currency');
    const exchangeRateInput = document.getElementById('exchangeRate');
    const overtimeInput     = document.getElementById('overtimeMultiplier');
    const themeSelect       = document.getElementById('themeSelect');
    const chartRangeSelect  = document.getElementById('chartRange');

    // Kayƒ±tlƒ± deƒüerleri y√ºkle
    salaryInput && (salaryInput.value = localStorage.getItem('salary') || '');
    extraHoursInput && (extraHoursInput.value = localStorage.getItem('extraHours') || 0);
    extraMinutesInput && (extraMinutesInput.value = localStorage.getItem('extraMinutes') || 0);
    dailyGoalInput && (dailyGoalInput.value = goal);
    currencySelect && (currencySelect.value = currency);
    exchangeRateInput && (exchangeRateInput.value = exchangeRate);
    overtimeInput && (overtimeInput.value = overtimeMultiplier);
    themeSelect && (themeSelect.value = localStorage.getItem('theme') || 'auto');
    monthlyLimitInput && (monthlyLimitInput.value = monthlyLimit);

    // Tema Uygulama
    function applyTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') document.body.classList.remove('dark');
      else if (saved === 'dark') document.body.classList.add('dark');
      else {
        const hour = new Date().getHours();
        if (hour >= 19 || hour < 6) document.body.classList.add('dark');
        else document.body.classList.remove('dark');
      }
    }
    themeSelect && (themeSelect.onchange = () => {
      localStorage.setItem('theme', themeSelect.value);
      applyTheme();
    });
    applyTheme();

    // Input deƒüi≈üimlerini kaydet
    salaryInput       && (salaryInput.onchange       = () => localStorage.setItem('salary', salaryInput.value));
    extraHoursInput   && (extraHoursInput.onchange   = () => localStorage.setItem('extraHours', extraHoursInput.value));
    extraMinutesInput && (extraMinutesInput.onchange = () => localStorage.setItem('extraMinutes', extraMinutesInput.value));
    dailyGoalInput    && (dailyGoalInput.onchange    = () => {
      localStorage.setItem('dailyGoal', dailyGoalInput.value);
      goal = parseFloat(dailyGoalInput.value);
    });
    currencySelect    && (currencySelect.onchange     = () => {
      currency = currencySelect.value;
      localStorage.setItem('currency', currency);
      drawChart();
      updateDisplay();
    });
    exchangeRateInput && (exchangeRateInput.onchange  = () => {
      exchangeRate = parseFloat(exchangeRateInput.value) || 1;
      localStorage.setItem('exchangeRate', exchangeRate);
      drawChart();
      updateDisplay();
    });
    overtimeInput     && (overtimeInput.onchange      = () => {
      overtimeMultiplier = parseFloat(overtimeInput.value) || 1.5;
      localStorage.setItem('overtimeMultiplier', overtimeMultiplier);
    });
    monthlyLimitInput && (monthlyLimitInput.onchange  = () => {
      const val = parseFloat(monthlyLimitInput.value);
      if (isNaN(val) || val <= 0) {
        alert("L√ºtfen aylƒ±k √ßalƒ±≈üma s√ºresi limiti i√ßin ge√ßerli bir sayƒ± girin (0‚Äôdan b√ºy√ºk).");
        monthlyLimitInput.value = monthlyLimit;
        return;
      }
      monthlyLimit = val;
      localStorage.setItem('monthlyLimit', monthlyLimit);
      updateDisplay();
      drawChart();
    });

    const startSound = document.getElementById('startSound');
    const stopSound  = document.getElementById('stopSound');

    // Yardƒ±mcƒ±: ge√ßerli toplam saniyeyi al (mola s√ºresini √ßƒ±kararak)
    function getCurrentSeconds() {
      if (isRunning && startTimestamp !== null) {
        const now = Math.floor(Date.now() / 1000);
        let rawWork = baseSeconds + (now - startTimestamp);

        if (isOnBreak && breakStartTimestamp) {
          const thisBreak = now - breakStartTimestamp;
          return rawWork - (accumulatedBreakSeconds + thisBreak);
        }
        return rawWork - accumulatedBreakSeconds;
      }
      return baseSeconds - accumulatedBreakSeconds;
    }

    // Fazla mesai ayrƒ±mƒ± ve kazan√ß hesaplama
    function calculateEarnings(totalSec) {
      if (!monthlyLimit || monthlyLimit <= 0) return { total: 0, regular: 0, overtime: 0 };
      const salary = parseFloat(salaryInput.value);
      if (isNaN(salary)) return { total: 0, regular: 0, overtime: 0 };
      const hourlyRate = salary / monthlyLimit;
      const limitSec = monthlyLimit * 3600;
      const regularSeconds = Math.min(totalSec, limitSec);
      const overtimeSeconds = Math.max(totalSec - limitSec, 0);
      const regularEarnings = +(regularSeconds * (hourlyRate / 3600)).toFixed(2);
      const overtimeEarnings = +(overtimeSeconds * (hourlyRate / 3600) * overtimeMultiplier).toFixed(2);
      return {
        total: +(regularEarnings + overtimeEarnings).toFixed(2),
        regular: regularEarnings,
        overtime: overtimeEarnings
      };
    }

    // G√ºnl√ºk hedef kontrol√º (her g√ºn sadece bir kez)
    function checkDailyGoal(totalSec) {
      const todayKey = new Date().toISOString().split('T')[0];
      const alreadyNotified = localStorage.getItem('goalCongrats_' + todayKey);
      const hoursWorked = totalSec / 3600;
      if (hoursWorked >= goal && !alreadyNotified) {
        alert('üéâ Tebrikler! G√ºnl√ºk hedefi a≈ütƒ±nƒ±z.');
        localStorage.setItem('goalCongrats_' + todayKey, 'true');
      }
    }

    function updateDisplay() {
      const totalSec = getCurrentSeconds();
      const { total, regular, overtime } = calculateEarnings(totalSec);
      document.getElementById('earnings').innerText = total.toFixed(2).replace('.', ',') + ' ' + currency;
      document.getElementById('earningsDetail').innerText =
        `Normal: ${regular.toFixed(2).replace('.', ',')} TL  |  Fazla Mesai: ${overtime.toFixed(2).replace('.', ',')} TL`;

      // Toplam s√ºre hesaplama
      const hours = Math.floor(totalSec / 3600);
      const remAfterHours = totalSec - hours * 3600;
      const minutes = Math.floor(remAfterHours / 60);
      const seconds = remAfterHours - minutes * 60;
      document.getElementById('timeDisplay').innerText =
        `Toplam S√ºre: ${hours} saat ${minutes} dakika ${seconds} saniye`;

      // Fazla mesai s√ºresi
      const limitSec = monthlyLimit * 3600;
      const extraTime = totalSec > limitSec ? (totalSec - limitSec) : 0;
      const ehours = Math.floor(extraTime / 3600);
      const eminutes = Math.floor((extraTime - ehours * 3600) / 60);
      const eseconds = extraTime - ehours * 3600 - eminutes * 60;
      document.getElementById('overtimeDisplay').innerText =
        `Fazla Mesai: ${ehours} saat ${eminutes} dakika ${eseconds} saniye`;

      // Kalan aylƒ±k s√ºre
      const remainingSec = limitSec - totalSec;
      if (remainingSec > 0) {
        const rh = Math.floor(remainingSec / 3600);
        const remRem = remainingSec - rh * 3600;
        const rm = Math.floor(remRem / 60);
        document.getElementById('remainingTime').innerText =
          `Aylƒ±k limitten kalan s√ºre: ${rh} saat ${rm} dakika`;
      } else {
        document.getElementById('remainingTime').innerText = "Aylƒ±k limit a≈üƒ±ldƒ±.";
      }

      checkDailyGoal(totalSec);
    }

    function startTracking() {
      if (isRunning) return;

      const salary = parseFloat(salaryInput.value);
      if (isNaN(salary) || salary <= 0) {
        alert("L√ºtfen ge√ßerli bir maa≈ü bilgisi girin.");
        return;
      }

      // Eƒüer daha √∂nce sayfa yenilendiyse ve hala moladaysa, butonu doƒüru duruma getir
      const btn = document.getElementById('breakButton');
      if (isOnBreak) {
        btn.innerText = "MOLADAN D√ñN";
        btn.style.background = "#FF9800";
        btn.style.color = "#fff";
      } else {
        btn.innerText = "MOLA";
        btn.style.background = "";
        btn.style.color = "";
      }

      // "Ek S√ºre" yalnƒ±zca bir kez eklenir, sonrasƒ±nda kutuyu sƒ±fƒ±rla
      if (!isRunning && baseSeconds === parseInt(localStorage.getItem('baseSeconds') || '0')) {
        const extraSec = ((+extraHoursInput.value || 0) * 3600) +
                         ((+extraMinutesInput.value || 0) * 60);
        baseSeconds += extraSec;
        localStorage.setItem('baseSeconds', baseSeconds);
        // Ek s√ºre kutularƒ±nƒ± sƒ±fƒ±rla
        extraHoursInput.value = 0;
        extraMinutesInput.value = 0;
        localStorage.setItem('extraHours', 0);
        localStorage.setItem('extraMinutes', 0);
      }

      startSound.currentTime = 0;
      startSound.play().catch(()=>{});

      startTimestamp = Math.floor(Date.now() / 1000);
      isRunning = true;
      localStorage.setItem('startTimestamp', startTimestamp);
      localStorage.setItem('isRunning', 'true');

      updateDisplay();

      timer = setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        const totalSec = getCurrentSeconds();
        const { total: earn } = calculateEarnings(totalSec);
        earnings = earn;
        const todayKey = new Date().toISOString().split('T')[0];
        localStorage.setItem('daily_' + todayKey, earnings);
        localStorage.setItem('dailySeconds_' + todayKey, totalSec);
        localStorage.setItem('earnings', earnings);
        updateDisplay();
      }, 1000);
    }

    function stopTracking() {
      if (!isRunning) return;

      // Eƒüer moladaysa, molayƒ± bitir
      if (isOnBreak && breakStartTimestamp) {
        const now = Math.floor(Date.now()/1000);
        const thisBreak = now - breakStartTimestamp;
        accumulatedBreakSeconds += thisBreak;
        localStorage.setItem('accumulatedBreakSeconds', accumulatedBreakSeconds);
        isOnBreak = false;
        localStorage.setItem('isOnBreak', 'false');
        localStorage.removeItem('breakStartTimestamp');
        // Butonu temizle
        const btn = document.getElementById('breakButton');
        btn.innerText = "MOLA";
        btn.style.background = "";
        btn.style.color = "";
      }

      stopSound.currentTime = 0;
      stopSound.play().catch(()=>{});
      clearInterval(timer);

      const now = Math.floor(Date.now() / 1000);
      const totalRaw = baseSeconds + (now - startTimestamp);
      baseSeconds = totalRaw;
      localStorage.setItem('baseSeconds', baseSeconds);

      const totalSec = getCurrentSeconds();
      const { total: earn } = calculateEarnings(totalSec);
      earnings = earn;
      localStorage.setItem('earnings', earnings);
      const todayKey = new Date().toISOString().split('T')[0];
      localStorage.setItem('daily_' + todayKey, earnings);

      isRunning = false;
      localStorage.setItem('isRunning', 'false');

      updateDisplay();
    }

    function toggleBreak() {
      if (!isRunning) {
        alert("√ñnce √ßalƒ±≈ümayƒ± ba≈ülatƒ±n, sonra mola verebilirsiniz.");
        return;
      }

      const now = Math.floor(Date.now() / 1000);
      const btn = document.getElementById('breakButton');

      if (!isOnBreak) {
        // Mola Ba≈ülatƒ±lƒ±yor
        isOnBreak = true;
        breakStartTimestamp = now;
        localStorage.setItem('breakStartTimestamp', breakStartTimestamp);
        localStorage.setItem('isOnBreak', 'true');
        btn.innerText = "MOLADAN D√ñN";
        btn.style.background = "#FF9800";
        btn.style.color = "#fff";
      } else {
        // Mola Bitiriliyor
        const thisBreak = now - breakStartTimestamp;
        accumulatedBreakSeconds += thisBreak;
        localStorage.setItem('accumulatedBreakSeconds', accumulatedBreakSeconds);
        localStorage.removeItem('breakStartTimestamp');
        isOnBreak = false;
        localStorage.setItem('isOnBreak', 'false');
        btn.innerText = "MOLA";
        btn.style.background = "";
        btn.style.color = "";
        updateDisplay();
      }
    }

    function confirmDailyReset() {
      if (confirm("Bu g√ºn√ºn verileri silinecek. Emin misiniz?")) {
        resetDaily();
      }
    }

    function resetDaily() {
      const todayKey = new Date().toISOString().split('T')[0];
      localStorage.removeItem('daily_' + todayKey);
      localStorage.removeItem('goalCongrats_' + todayKey);
      baseSeconds = 0;
      earnings = 0;
      localStorage.setItem('baseSeconds', 0);
      localStorage.setItem('earnings', 0);
      if (isRunning) {
        startTimestamp = Math.floor(Date.now() / 1000);
        localStorage.setItem('startTimestamp', startTimestamp);
      }
      updateDisplay();
      drawAllCharts();
    }

    function confirmAllReset() {
      if (confirm("Uygulamadaki t√ºm veriler silinecek. Emin misiniz?")) {
        resetAll();
      }
    }

    function resetAll() {
      clearInterval(timer);
      localStorage.clear();
      location.reload();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    function showView(view) {
      document.getElementById('mainView').classList.add('hidden');
      document.getElementById('profileView').classList.add('hidden');
      document.getElementById('settingsView').classList.add('hidden');
      document.getElementById(view + 'View').classList.remove('hidden');
      if (view === 'profile') drawAllCharts();
    }

    function formatNumber(val) {
      return val.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    }

    // Grafik √ßizme: √áalƒ±≈üma, Bo≈üta, Kazan√ß
    let workChart, idleChart, earnChart;
    function drawAllCharts() {
      drawWorkChart();
      drawIdleChart();
      drawEarnChart();
    }

    function drawWorkChart() {
      const ctx = document.getElementById('workChart').getContext('2d');
      const labels = [];
      const data = [];
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const key = d.toISOString().split('T')[0];
        labels.push(key.slice(5));
        const daySec = parseInt(localStorage.getItem('dailySeconds_' + key)) || 0;
        data.push(parseFloat((daySec / 3600).toFixed(2)));
      }
      if (workChart) workChart.destroy();
      workChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '√áalƒ±≈üƒ±lan Saat',
            data: data,
            borderColor: 'var(--work-color)',
            backgroundColor: 'rgba(26, 115, 232, 0.3)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function drawIdleChart() {
      const ctx = document.getElementById('idleChart').getContext('2d');
      const labels = [];
      const data = [];
      const today = new Date();
      const dailyLimitSec = 24 * 3600;
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const key = d.toISOString().split('T')[0];
        labels.push(key.slice(5));
        const daySec = parseInt(localStorage.getItem('dailySeconds_' + key)) || 0;
        const idleSec = Math.max(dailyLimitSec - daySec, 0);
        data.push(parseFloat((idleSec / 3600).toFixed(2)));
      }
      if (idleChart) idleChart.destroy();
      idleChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Bo≈üta Kalan Saat',
            data: data,
            borderColor: 'var(--idle-color)',
            backgroundColor: 'rgba(232, 26, 26, 0.3)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function drawEarnChart() {
      const ctx = document.getElementById('earningsChart').getContext('2d');
      const labels = [];
      const data = [];
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const key = d.toISOString().split('T')[0];
        labels.push(key.slice(5));
        data.push(parseFloat(localStorage.getItem('daily_' + key) || 0));
      }
      if (earnChart) earnChart.destroy();
      earnChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Kazanƒ±lan (' + currency + ')',
            data: data,
            borderColor: 'var(--earn-color)',
            backgroundColor: 'rgba(26, 232, 26, 0.3)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function convertCurrency(val) {
      return currency === 'TL' ? val : +(val / exchangeRate).toFixed(2);
    }

    window.onload = () => {
      const btn = document.getElementById('breakButton');
      if (btn) {
        if (isOnBreak) {
          btn.innerText = "MOLADAN D√ñN";
          btn.style.background = "#FF9800";
          btn.style.color = "#fff";
        } else {
          btn.innerText = "MOLA";
          btn.style.background = "";
          btn.style.color = "";
        }
      }

      if (localStorage.getItem('isRunning') === 'true') {
        startTimestamp = parseInt(localStorage.getItem('startTimestamp')) || null;
        baseSeconds = parseInt(localStorage.getItem('baseSeconds')) || 0;
        accumulatedBreakSeconds = parseInt(localStorage.getItem('accumulatedBreakSeconds')) || 0;
        isRunning = true;
        timer = setInterval(() => {
          const totalSec = getCurrentSeconds();
          const { total: earn } = calculateEarnings(totalSec);
          earnings = earn;
          const todayKey = new Date().toISOString().split('T')[0];
          localStorage.setItem('daily_' + todayKey, earnings);
          localStorage.setItem('dailySeconds_' + todayKey, totalSec);
          localStorage.setItem('earnings', earnings);
          updateDisplay();
          if ((totalSec / 3600) >= goal) checkDailyGoal(totalSec);
        }, 1000);
      } else {
        baseSeconds = parseInt(localStorage.getItem('baseSeconds')) || 0;
        accumulatedBreakSeconds = parseInt(localStorage.getItem('accumulatedBreakSeconds')) || 0;
        earnings = parseFloat(localStorage.getItem('earnings')) || 0;
        const todayKey = new Date().toISOString().split('T')[0];
        const currentSec = parseInt(localStorage.getItem('dailySeconds_' + todayKey)) || 0;
        updateDisplay();
      }
      drawAllCharts();
    };
  </script>
</body>
</html>
